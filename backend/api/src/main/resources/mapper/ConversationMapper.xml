<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.aivideo.api.mapper.ConversationMapper">

    <resultMap id="ConversationResultMap" type="com.aivideo.api.entity.Conversation">
        <id property="conversationId" column="conversation_id"/>
        <result property="userNo" column="user_no"/>
        <result property="creatorId" column="creator_id"/>
        <result property="videoId" column="video_id"/>
        <result property="initialPrompt" column="initial_prompt"/>
        <result property="referenceImageUrl" column="reference_image_url"/>
        <result property="referenceImageAnalysis" column="reference_image_analysis"/>
        <result property="contentType" column="content_type"/>
        <result property="qualityTier" column="quality_tier"/>
        <result property="videoDuration" column="video_duration"/>
        <result property="status" column="status"/>
        <result property="currentStep" column="current_step"/>
        <result property="questionCount" column="question_count"/>
        <result property="totalMessages" column="total_messages"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="completedAt" column="completed_at"/>
    </resultMap>

    <!-- 대화 세션 생성 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="conversationId" parameterType="com.aivideo.api.entity.Conversation">
        INSERT INTO conversations (
            user_no,
            creator_id,
            initial_prompt,
            reference_image_url,
            reference_image_analysis,
            content_type,
            quality_tier,
            video_duration,
            status,
            current_step,
            question_count,
            total_messages
        ) VALUES (
            #{userNo},
            #{creatorId},
            #{initialPrompt},
            #{referenceImageUrl},
            #{referenceImageAnalysis},
            #{contentType},
            #{qualityTier},
            #{videoDuration},
            #{status},
            #{currentStep},
            #{questionCount},
            #{totalMessages}
        )
    </insert>

    <!-- 대화 ID로 조회 -->
    <select id="findById" resultMap="ConversationResultMap">
        SELECT * FROM conversations
        WHERE conversation_id = #{conversationId}
    </select>

    <!-- 사용자 번호와 상태로 대화 목록 조회 -->
    <select id="findByUserNoAndStatus" resultMap="ConversationResultMap">
        SELECT * FROM conversations
        WHERE user_no = #{userNo}
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 사용자의 모든 대화 목록 조회 (상태 무관) -->
    <select id="findAllByUserNo" resultMap="ConversationResultMap">
        SELECT * FROM conversations
        WHERE user_no = #{userNo}
        ORDER BY created_at DESC
    </select>

    <!-- 대화 상태 업데이트 -->
    <update id="updateStatus">
        UPDATE conversations
        SET status = #{status},
            updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 현재 단계 업데이트 -->
    <update id="updateCurrentStep">
        UPDATE conversations
        SET current_step = #{currentStep},
            updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- v2.9.94: 조건부 현재 단계 업데이트 (VIDEO 관련 상태 보호) -->
    <!-- 레이스 컨디션 방지: VIDEO_DONE, VIDEO_GENERATING, VIDEO_FAILED 상태가 아닐 때만 업데이트 -->
    <update id="updateCurrentStepIfNotVideoState">
        UPDATE conversations
        SET current_step = #{currentStep},
            updated_at = NOW()
        WHERE conversation_id = #{conversationId}
          AND current_step NOT IN ('VIDEO_DONE', 'VIDEO_GENERATING', 'VIDEO_FAILED')
    </update>

    <!-- 질문 횟수 증가 -->
    <update id="incrementQuestionCount">
        UPDATE conversations
        SET question_count = question_count + 1,
            updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 총 메시지 수 증가 -->
    <update id="incrementTotalMessages">
        UPDATE conversations
        SET total_messages = total_messages + 1,
            updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 초기 프롬프트 업데이트 -->
    <update id="updateInitialPrompt">
        UPDATE conversations
        SET initial_prompt = #{initialPrompt},
            updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 영상 길이 업데이트 -->
    <update id="updateVideoDuration">
        UPDATE conversations
        SET video_duration = #{videoDuration},
            updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 영상 ID 업데이트 -->
    <update id="updateVideoId">
        UPDATE conversations
        SET video_id = #{videoId},
            updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 크리에이터 ID 업데이트 (v2.9.134: genreId → creatorId) -->
    <update id="updateCreatorId">
        UPDATE conversations
        SET creator_id = #{creatorId},
            updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- v2.9.84: 참조 이미지 정보 업데이트 -->
    <update id="updateReferenceImage">
        UPDATE conversations
        SET reference_image_url = #{referenceImageUrl},
            reference_image_analysis = #{referenceImageAnalysis},
            updated_at = NOW()
        WHERE conversation_id = #{conversationId}
    </update>

    <!-- 대화 삭제 -->
    <delete id="delete">
        DELETE FROM conversations
        WHERE conversation_id = #{conversationId}
    </delete>

    <!-- v2.9.40: 사용자의 진행 중인 대화 조회 (프리뷰 생성 중 이후 단계만 차단) -->
    <!-- 시나리오 생성 전 단계는 허용, 프리뷰 생성 중 이후만 차단 -->
    <select id="findInProgressConversationByUserNo" resultMap="ConversationResultMap">
        SELECT c.*
        FROM conversations c
        WHERE c.user_no = #{userNo}
          AND c.current_step IN (
              'PREVIEWS_GENERATING',   -- 프리뷰 생성 중
              'IMAGES_GENERATING',     -- 이미지 생성 중
              'IMAGES_DONE',           -- 이미지 완료
              'AUDIO_GENERATING',      -- TTS 생성 중
              'AUDIO_DONE',            -- TTS 완료
              'VIDEO_GENERATING'       -- 영상 합성 중
              -- VIDEO_DONE은 제외 (완료된 채팅)
          )
        ORDER BY c.updated_at DESC
        LIMIT 1
    </select>

    <!-- v2.9.40: 사용자의 진행 중인 대화 조회 (현재 채팅 제외, 프리뷰 생성 중 이후만 차단) -->
    <select id="findInProgressConversationExcludingCurrent" resultMap="ConversationResultMap">
        SELECT c.*
        FROM conversations c
        WHERE c.user_no = #{userNo}
          AND c.conversation_id != #{excludeChatId}  -- 현재 채팅 제외
          AND c.current_step IN (
              'PREVIEWS_GENERATING',   -- 프리뷰 생성 중
              'IMAGES_GENERATING',     -- 이미지 생성 중
              'IMAGES_DONE',           -- 이미지 완료
              'AUDIO_GENERATING',      -- TTS 생성 중
              'AUDIO_DONE',            -- TTS 완료
              'VIDEO_GENERATING'       -- 영상 합성 중
              -- VIDEO_DONE은 제외 (완료된 채팅)
          )
        ORDER BY c.updated_at DESC
        LIMIT 1
    </select>

</mapper>
